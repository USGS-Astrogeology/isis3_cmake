pipeline { 
    agent {
        docker.image('usgsastro/docker_linux_isisdeps')
    }
    stages {
        stage('Inject Variables') { 
            steps { 
                sh '''
                    pwd
                    ls
                    mkdir -p ./install ./build
                '''
            }
        }
        stage('Config') { 
            steps { 
                dir('build'){
                    sh '''
                        cmake -GNinja -DCMAKE_INSTALL_PREFIX=../install -Disis3Data=/usgs/cpkgs/isis3/data -Disis3TestData=/usgs/cpkgs/isis3/testData ../isis
                    '''
                }
            }
        }
        stage('Build') { 
            steps { 
                dir('build'){
                    sh '''
                        ninja
                        ninja install
                    '''
                }
            }
        }
//        stage('Test'){
//            steps {
//                dir('build'){
//                    sh '''
//                        ctest -R _unit
//                    '''
//                }
//            }
//        }
    }
    post {
        success {
            sh 'pwd && ls'
            archiveArtifacts artifacts: "build/objects/*.o"
        }
        always {
            mail to: 'ccombs@usgs.gov',
                    subject: "Build Finished: ${currentBuild.fullDisplayName}",
                    body: "Link: ${env.BUILD_URL}"
//            cleanWs()
        }
    }
}
